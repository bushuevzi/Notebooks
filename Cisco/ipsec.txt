Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.4
Creation-Date: 2017-04-02T23:31:43+03:00

====== ipsec ======
Created Воскресенье 02 Апрель 2017

== ================================================================================== ==
**!<------------ создание политик-------------------->**
**R-MAIN(config)#**
**crypto isakmp policy 1**       # ← создания IKE политики, в которой указываются желаемые алгоритмы и параметры создаваемого
			 		          #  защищенного канала, которые будут предложены партнеру для согласования. Этот канал будет обеспечивать
						  # защиту части обменов информацией первой фазы и все обмены второй фазы IKE. **crypto isakmp policy {priority}**
	**encr 3des**
	**authentication pre-share**
	**group 2**
	**lifetime 5000**

**crypto ipsec transform-set ESP_3DES_SHA_HMAC esp-3des esp-sha-hmac      **# формирование протоколов защиты и криптографических алгоритмов
**crypto ipsec df-bit clear **				#  ← см. пояснения ниже

**crypto ipsec profile VTI_PROF			** # ← создание профиля
**set transform-set ESP_3DES_SHA_HMAC **# ←указания набора преобразований
**set pfs group2						**# ← установка опции PFS. 

**!<------------ создание ключей IPsec-------------------->**
**R-MAIN(config)#**
**crypto isakmp key 0 12345 address 2.2.2.2**

**R-BRANCH(config)#**
**crypto isakmp key 0 12345 address 1.1.1.2**    # ← Цифра 0 обозначает, что ключ вводится в незашифрованном виде. ключ «12345», рекомендуется не менее 50 символов. Ключ шифрования должен быть одинаковым на обоих маршрутизаторах

**!<------------ Создание тоннельных интерфейсов-------------------->**
**R-MAIN(config)#**
**interface Tunnel1**
**description Link to R-BRANC**H
**ip address 10.0.0.1 255.255.255.252**				— собственный адрес виртуального тоннеля   
**tunnel source FastEthernet 0/0** 					— собственный внешний интерфейс маршрутизатора                              
**tunnel destination 2.2.2.2**							— внешний адрес маршрутизатора дополнительного офиса
**tunnel mode ipsec ipv4**							— вид шифрования
**tunnel protection ipsec profile VTI_PROF**			— способ шифрования
**Важно!**
Если после ввода последних 2ух строк у вас появились сообщения об ошибках и маршрутизатор не  принимает эти команды, то удалите профиль шифрования командой **no crypto ipsec profile VTI_PROF **На Вашем маршрутизаторе с текущей версией операционной системы IOS не получится воспользоваться этим способом. Переходите к **способу 2**.
**R-BRANCH(config)#**
**interface Tunnel1**
**description Link to R-MAIN**
**ip address 10.0.0.2 255.255.255.252**
**tunnel source FastEthernet 4**
**tunnel destination 1.1.1.2**
**tunnel mode ipsec ipv4**
**tunnel protection ipsec profile VTI_PROF**

**!<------------ Проверка работы VPN тоннеля-------------------->**
из головного офиса(R-MAIN):
**R-MAIN#ping 10.0.0.2**
Дополнительно убеждаемся, что пакеты проходят именно через защищенный тоннель:
**R-MAIN#sh cry ips sa peer 2.2.2.2**
**interface: Tunnel1**
**Crypto map tag: Tunnel1-head-0, local addr 2.2.2.2**
**protected vrf: (none)**
**local**
**ident (addr/mask/prot/port): (0.0.0.0/0.0.0.0/0/0)**
**remote ident (addr/mask/prot/port): (0.0.0.0/0.0.0.0/0/0)**
**current_peer 2.2.2.2 port 500**
**PERMIT, flags={origin_is_acl,}**
**#pkts encaps:5, #pkts encrypt: 5, #pkts digest: 5**
**#pkts decaps: 5, #pkts decrypt: 5, #pkts verify: 5**
**/...вырезано.../**
Последние две строчки показывают, что маршрутизатор зашифровал и отправил 5 пакетов и столько же получил и
расшифровал. Эти счетчики будут срабатывать каждый раз, когда какой-либо пакет будет проходить по тоннелю
между нашими маршрутизаторами.

__пояснения:__
**authentication** - метод аутентификации сторон http://doc.s-terra.ru/rh_output/4.1/Gate/output/mergedProjects/Console/authentication_IKE_policy.htm
**encryption -** алгоритм шифрования сообщений http://doc.s-terra.ru/rh_output/4.1/Gate/output/mergedProjects/Console/encryption_IKE_policy.htm
**hash - **хэш-алгоритм, используемый для контроля целостности сообщений в рамках ISAKMP SA http://doc.s-terra.ru/rh_output/4.1/Gate/output/mergedProjects/Console/hash_IKE_policy.htm
**lifetime**  - время жизни IKE SA  http://doc.s-terra.ru/rh_output/4.1/Gate/output/mergedProjects/Console/lifetime_IKE_policy.htm
**group**  - алгоритм, используемый в рамках протокола IKE для выработки ключевого материала.
	vko                                используется алгоритм VKO GOST R 34.10-2001, длина ключа 256 бит
	vko2                               используется алгоритм VKO GOST R 34.10-2012, длина ключа 256 бит. Алгоритм VKO GOST R 34.10-2012 может применяться, только если используется криптобиблиотека, разработанная компанией «С-Терра СиЭсПи» 
	1                                    используется алгоритм Диффи-Хеллмана, длина ключа 768 бит
	2                                    используется алгоритм Диффи-Хеллмана, длина ключа 1024 бит  
	5                                    используется алгоритм Диффи-Хеллмана, длина ключа 1536 бит http://doc.s-terra.ru/rh_output/4.1/Gate/output/mergedProjects/Console/group_IKE_policy.htm
**crypto ipsec transform-set** transform-set-name transform1 [transform2 [transform3]] - формироване набора преобразований – комбинации протоколов защиты и криптографических алгоритмов. http://doc.s-terra.ru/rh_output/4.1/Gate/output/mergedProjects/Console/crypto_ipsec_transform-set.htm
{{./pasted_image001.png}}
**crypto ipsec df-bit -- **установка DF-бита во внешнем заголовке пакета после IPsec инкапсуляции в туннельном режиме (Interface configuration.).
	clear                            DF-бит внешнего IP-заголовка будет очищен и пакет может быть фрагментирован после IPsec инкапсуляции
	set                                DF-бит внешнего IP-заголовка будет установлен, фрагментация пакета запрещена
	copy                              DF-бит внешнего IP-заголовка устанавливается в то же значение, какое было у оригинального пакета.

**set pfs group2	--** установка опции PFS(Perfect Forward Secrecy) позволяет удостовериться, что ключи, которые используются на второй фазе (то есть, для защиты данных), не были получены из ключей на первой фазе. Использование данной опции позволяет повысить уровень защищенности трафика – при создании каждого IPsec SA производится выработка новых сессионных ключей.
	vko                                используется алгоритм VKO GOST R 34.10-2001 [RFC4357], длина ключа 256 бит
	vko2                              используется алгоритм VKO GOST R 34.10-2012, длина ключа 256 бит. Алгоритм VKO GOST R 34.10-2012 может применяться, только если используется криптобиблиотека, разработанная компанией «С-Терра СиЭсПи»
	group1                          используется алгоритм Диффи-Хеллмана, длина ключа 768 бит
	group2                          используется алгоритм Диффи-Хеллмана, длина ключа 1024 бита
	group5                          используется алгоритм Диффи-Хеллмана, длина ключа 1536 бит

== ========================================================================================= ==

**Проверка Ipsec** - https://habrahabr.ru/company/xakep/blog/256659/

Назависимо от используемого ПО, все VPN работают по следующим принципам:
   1)Каждый из узлов идентифицирует друг друга перед созданием туннеля, чтобы удостовериться, что шифрованные данные будут отправлены на нужный узел
   2) Оба узла требуют заранее настроеной политики, указывающей какие протоколы могут использоваться для шифрования и обеспечения целостности данных
   3) Узлы сверяют политики, чтобы договориться об используемых алгоритмах; если это не получается, то туннель не устанавливается
   4) Как только достигнуто соглашение по алгоритмам, создаётся ключ, который будет использован в симметричном алгоритме для шифрования/расшифровки данных

Т.к. каждый узел способен устанавливать несколько туннелей с другими узлами, каждый SA имеет уникальный номер, позволяющий определить к какому узлу он относится. Это номер называется **SPI (Security Parameter Index)** или индекс параметра безопасности. 

**ISAKMP** (Internet Security Association and Key Management Protocol) – определяет концепцию управления и обмена ключами, управления и установления SA. IKE – это реализация концепции ISAKMP для использования с IPsec.
ISAKMP определяет процедуры аутентификации участников, создания и управления SA, определяет техники генерации ключей и обеспечения защиты от угроз.
Работа ISAKMP разбивается на две отдельные фазы. Во время первой фазы для защиты дальнейших коммуникаций между участниками устанавливаются ISAKMP SA. Во время второй фазы устанавливаются SA для IPsec.
Одно ISAKMP SA может использоваться для нескольких security associations других протоколов. 

 **AH** (Authentication Header) - протокол заголовка идентификации. Обеспечивает целостность путём проверки того, что ни один бит в защищаемой части пакета не был изменён во время передачи. Отметим, что использование AH может вызвать проблемы, например, при прохождении пакета через NAT устройство. NAT меняет IP адрес пакета, чтобы разрешить доступ в Интернет с закрытого локального адреса. Т.к. пакет в таком случае изменится, то контрольная сумма AH станет неверной. Также стоит отметить, что AH разрабатывался только для обеспечения целостности. Он не гарантирует конфиденциальности путём шифрования содержимого пакета. номер ID (в заголовке пакета) - 51 

**ESP** (Encapsulating Security Protocol) - инкапсулирующий протокол безопасности, который обеспечивает и целостность и конфиденциальность. В режиме транспорта ESP заголовок находится между оригинальным IP заголовком и заголовком TCP или UDP. В режиме туннеля заголовок ESP размещается между новым IP заголовком и полностью зашифрованным оригинальным IP пакетом.  номер ID (в заголовке пакета) - 50 

**IKE** или Internet Key Exchange protocol. Как следует из названия, он предназначен для обмена ключами между двумя узлами VPN. Насмотря на то, что генерировать ключи можно вручную, лучшим и более масштабируемым вариантом будет автоматизация этого процесса с помощью IKE. Помните, что ключи должны часто меняться, и вам наверняка не хочется полагаться на свою память, чтобы найти время для совершения этой операции вручную. Главное - не забудьте настроить правило на файрволе для UPD порта с номером 500, т.к. именно этот порт используется IKE. номер ID (в заголовке пакета) - 500
-----------------------------------------------------------------------------------------
Политика IPSec включает в себя:
1. Симметричные алгоритмы для шифрования/расшифровки данных
2. Криптографические контрольные суммы для проверки целостности данных
3. Способ идентификации узла. Самые распространнённые способы - это предустановленные ключи (pre-shared secrets) или RSA сертификаты.
4. Использовать ли режим туннеля или режим транспорта
5. Какую использовать группу Diffie Hellman
6. Как часто проводить переидентификацию узла
7. Как часто менять ключ для шифрования данных
8. Использовать ли PFS
9. Использовать ли AH, ESP, или оба вместе
Основной режим IKE 
**(Main mode)** реализует стандартный механизм установления «канала» ISAKMP SA. Он включает в себя три процедуры двунаправленного обмена. Сначала стороны договариваются о базовых алгоритмах и используемых методах хеширования. Затем осуществляется обмен открытыми ключами в рамках алгоритма Диффи — Хеллмана и случайными числами (nonce), которые подписываются принимающими сторонами и отправляются обратно для идентификации. Наконец, в ходе третьего обмена по пришедшим обратно подписанным значениям nonce проверяется подлинность сторон. 

Ваша задача заключается в том, чтобы сконфигурировать оба узла с одинаковыми параметрами времени жизни (I**KE SA lifetime; IPSec SA lifetime**). Если этого не произойдёт, то возможен вариант, когда изначально туннель будет установлен успешно, но по истечении первого несогласованного промежутка времени жизни связь прервётся. Странные проблемы могут возникнуть и в том случае, когда время жизни Фазы Один меньше аналогичного параметра Фазы Два. **Если настроенный ранее туннель виснет, то первая вещь, которая нуждается в проверке - это время жизни на обоих узлах.** В заключение стоит упомянуть, что при смене политики на одном из узлов, изменения вступят в силу только при следующем наступлении Фазы Один. Чтобы изменения вступили в силу немедленно, надо убрать SA для этого туннеля из SAD. Это вызовёт пересмотр соглашения между узлами с новыми настройками политики безопасности.





{{./pasted_image.png}}
